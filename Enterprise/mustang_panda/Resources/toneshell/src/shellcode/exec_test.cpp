#include "exec.hpp"
#include "test_util.hpp"
#include <filesystem>
#include <fstream>
#include <gtest/gtest.h>

// Fills buffer with 0x0
NTSTATUS mock_BCryptGenRandom0(
    BCRYPT_ALG_HANDLE hAlgorithm,
    PUCHAR            pbBuffer,
    ULONG             cbBuffer,
    ULONG             dwFlags
) {
    for (ULONG i = 0; i < cbBuffer; i++) {
        pbBuffer[i] = 0x0;
    }
    return STATUS_SUCCESS;
}

class ExecTest : public ::testing::Test {
protected:
    task_command_data test_cmd_data;
    LPCSTR test_cmd = "cmd.exe /c echo Hello World!";
    std::string test_file_data = "Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?";
    LPCSTR test_download_dst = "C:\\Windows\\Temp\\orph_test_download.txt";
    LPCSTR test_upload_src = "C:\\Windows\\Temp\\orph_test_upload.txt";

    virtual void SetUp() {
        test_utils::Initialize();
        test_utils::mock_context.fp.shared_fp.fp_BCryptGenRandom = mock_BCryptGenRandom0;

        // Set up test task command struct
        test_cmd_data.task_num = 5;
        test_cmd_data.timeout = 120;
        memcpy(test_cmd_data.command, test_cmd, strlen(test_cmd));
        test_cmd_data.command_len = strlen(test_cmd);

        // Delete test download file if it exists
        if (std::filesystem::exists(test_download_dst)) {
            ASSERT_TRUE(std::filesystem::remove(test_download_dst));
        }

        // Populate test upload file
        std::ofstream ofs(test_upload_src, std::ios_base::out | std::ios_base::trunc);
        ofs << test_file_data;
        ofs.close();

        // Set up test file download data
        std::vector<unsigned char> header = {
            0x18,0x04,0x04, // magic
            0x62,0x03, // payload size (string length + 1 byte for msg type)
            0x06 // RESP_TYPE_FILE_CHUNK type
        };
        test_utils::mock_server_resp_data.insert(test_utils::mock_server_resp_data.end(), header.begin(), header.end());
        test_utils::mock_server_resp_data.insert(test_utils::mock_server_resp_data.end(), test_file_data.begin(), test_file_data.end());
    }

    virtual void TearDown() {
        test_utils::Cleanup();

        // Delete test download and upload file if they exist
        if (std::filesystem::exists(test_download_dst)) {
            ASSERT_TRUE(std::filesystem::remove(test_download_dst));
        }
        if (std::filesystem::exists(test_upload_src)) {
            ASSERT_TRUE(std::filesystem::remove(test_upload_src));
        }
    }
};

TEST_F(ExecTest, TestPerformExecTask) {
    ASSERT_EQ(PerformExecTask(&test_utils::mock_context, reinterpret_cast<client_message*>(test_utils::mock_client_send_buf.data()), NULL, &test_cmd_data), ERROR_SUCCESS);

    EXPECT_STREQ(test_utils::mock_context.command_buf, L"cmd.exe /c echo Hello World!");
    LPCSTR want = "Hello World!";

    // Verify output and task complete notification
    EXPECT_EQ(test_utils::mock_sent_data_vectors.size(), 2);
    unsigned char output_want[] = {
        0x18,0x04,0x04, // magic
        0x27,0x00, // payload size

        // XOR key
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

        // victim ID
        0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,
        0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,

        0x15, // task output type

        0x05,0x00,0x00,0x00, // task num
        0x0e,0x00,0x00,0x00, // task output size

        // task output
        0x48,0x65,0x6c,0x6c,0x6f,0x20,0x57,0x6f,0x72,0x6c,0x64,0x21,0x0d,0x0a
    };
    EXPECT_EQ(test_utils::mock_sent_data_vectors[0].size(), sizeof(output_want));
    EXPECT_EQ(0, memcmp(test_utils::mock_sent_data_vectors[0].data(), output_want, sizeof(output_want)));

    unsigned char notif_want[] = {
        0x18,0x04,0x04, // magic
        0x1d,0x00, // payload size

        // XOR key
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

        // victim ID
        0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,
        0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,

        0x14, // task complete type

        0x05,0x00,0x00,0x00, // task num
        0x05,0x00,0x00,0x00, // task type
        0x00,0x00,0x00,0x00 // exit code
    };
    EXPECT_EQ(test_utils::mock_sent_data_vectors[1].size(), sizeof(notif_want));
    EXPECT_EQ(0, memcmp(test_utils::mock_sent_data_vectors[1].data(), notif_want, sizeof(notif_want)));
}

TEST_F(ExecTest, TestPerformFileDownloadTask) {
    server_response* test_resp_buf = reinterpret_cast<server_response*>(test_utils::mock_client_recv_buf.data());
    task_start_download_data* task_data = reinterpret_cast<task_start_download_data*>(test_resp_buf->data);
    task_data->task_num = 7;
    memcpy(task_data->dest_path, test_download_dst, strlen(test_download_dst));
    task_data->dest_path_len = strlen(test_download_dst);
    ASSERT_EQ(
        PerformFileDownloadTask(
            &test_utils::mock_context,
            reinterpret_cast<client_message*>(test_utils::mock_client_send_buf.data()),
            test_resp_buf
        ),
        ERROR_SUCCESS
    );

    EXPECT_EQ(test_utils::mock_sent_data_vectors.size(), 2);
    unsigned char chunk_req_want[] = {
        0x18,0x04,0x04, // magic
        0x1d,0x00, // payload size

        // XOR key
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

        // victim ID
        0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,
        0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,

        0x13, // chunk req

        0x07,0x00,0x00,0x00, // task num
        0x00,0x00,0x00,0x00, // offset
        0x00,0x80,0x00,0x00 // max chunk size (32KB)
    };
    EXPECT_EQ(test_utils::mock_sent_data_vectors[0].size(), sizeof(chunk_req_want));
    EXPECT_EQ(0, memcmp(test_utils::mock_sent_data_vectors[0].data(), chunk_req_want, sizeof(chunk_req_want)));

    unsigned char notif_want[] = {
        0x18,0x04,0x04, // magic
        0x1d,0x00, // payload size

        // XOR key
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

        // victim ID
        0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,
        0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,

        0x14, // task complete type

        0x07,0x00,0x00,0x00, // task num
        0x03,0x00,0x00,0x00, // task type
        0x00,0x00,0x00,0x00 // exit code
    };
    EXPECT_EQ(test_utils::mock_sent_data_vectors[1].size(), sizeof(notif_want));
    EXPECT_EQ(0, memcmp(test_utils::mock_sent_data_vectors[1].data(), notif_want, sizeof(notif_want)));

    // Verify downloaded file contents
    std::ifstream output_file(test_download_dst);
    std::stringstream buf;
    buf << output_file.rdbuf();
    EXPECT_EQ(buf.str(), test_file_data);
}

TEST_F(ExecTest, TestPerformFileUploadTask) {
    server_response* test_resp_buf = reinterpret_cast<server_response*>(test_utils::mock_client_recv_buf.data());
    task_start_upload_data* task_data = reinterpret_cast<task_start_upload_data*>(test_resp_buf->data);
    task_data->task_num = 9;
    memcpy(task_data->src_path, test_upload_src, strlen(test_upload_src));
    task_data->src_path_len = strlen(test_upload_src);
    ASSERT_EQ(
        PerformFileUploadTask(
            &test_utils::mock_context,
            reinterpret_cast<client_message*>(test_utils::mock_client_send_buf.data()),
            NULL,
            task_data
        ),
        ERROR_SUCCESS
    );

    EXPECT_EQ(test_utils::mock_sent_data_vectors.size(), 2);
    unsigned char chunk_upload_want[] = {
        0x18,0x04,0x04, // magic
        0x7a,0x03, // payload size

        // XOR key
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

        // victim ID
        0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,
        0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,

        0x15, // task output
        0x09,0x00,0x00,0x00, // task num
        0x61,0x03,0x00,0x00, // file data size
        // file data
        0x53,0x65,0x64,0x20,0x75,0x74,0x20,0x70,0x65,0x72,0x73,0x70,0x69,0x63,0x69,0x61,0x74,0x69,0x73,0x20,0x75,0x6e,0x64,0x65,0x20,0x6f,0x6d,0x6e,0x69,0x73,0x20,0x69,0x73,0x74,0x65,0x20,0x6e,0x61,0x74,0x75,0x73,0x20,0x65,0x72,0x72,0x6f,0x72,0x20,0x73,0x69,0x74,0x20,0x76,0x6f,0x6c,0x75,0x70,0x74,0x61,0x74,0x65,0x6d,0x20,0x61,0x63,0x63,0x75,0x73,0x61,0x6e,0x74,0x69,0x75,0x6d,0x20,0x64,0x6f,0x6c,0x6f,0x72,0x65,0x6d,0x71,0x75,0x65,0x20,0x6c,0x61,0x75,0x64,0x61,0x6e,0x74,0x69,0x75,0x6d,0x2c,0x20,0x74,0x6f,0x74,0x61,0x6d,0x20,0x72,0x65,0x6d,0x20,0x61,0x70,0x65,0x72,0x69,0x61,0x6d,0x2c,0x20,0x65,0x61,0x71,0x75,0x65,0x20,0x69,0x70,0x73,0x61,0x20,0x71,0x75,0x61,0x65,0x20,0x61,0x62,0x20,0x69,0x6c,0x6c,0x6f,0x20,0x69,0x6e,0x76,0x65,0x6e,0x74,0x6f,0x72,0x65,0x20,0x76,0x65,0x72,0x69,0x74,0x61,0x74,0x69,0x73,0x20,0x65,0x74,0x20,0x71,0x75,0x61,0x73,0x69,0x20,0x61,0x72,0x63,0x68,0x69,0x74,0x65,0x63,0x74,0x6f,0x20,0x62,0x65,0x61,0x74,0x61,0x65,0x20,0x76,0x69,0x74,0x61,0x65,0x20,0x64,0x69,0x63,0x74,0x61,0x20,0x73,0x75,0x6e,0x74,0x20,0x65,0x78,0x70,0x6c,0x69,0x63,0x61,0x62,0x6f,0x2e,0x20,0x4e,0x65,0x6d,0x6f,0x20,0x65,0x6e,0x69,0x6d,0x20,0x69,0x70,0x73,0x61,0x6d,0x20,0x76,0x6f,0x6c,0x75,0x70,0x74,0x61,0x74,0x65,0x6d,0x20,0x71,0x75,0x69,0x61,0x20,0x76,0x6f,0x6c,0x75,0x70,0x74,0x61,0x73,0x20,0x73,0x69,0x74,0x20,0x61,0x73,0x70,0x65,0x72,0x6e,0x61,0x74,0x75,0x72,0x20,0x61,0x75,0x74,0x20,0x6f,0x64,0x69,0x74,0x20,0x61,0x75,0x74,0x20,0x66,0x75,0x67,0x69,0x74,0x2c,0x20,0x73,0x65,0x64,0x20,0x71,0x75,0x69,0x61,0x20,0x63,0x6f,0x6e,0x73,0x65,0x71,0x75,0x75,0x6e,0x74,0x75,0x72,0x20,0x6d,0x61,0x67,0x6e,0x69,0x20,0x64,0x6f,0x6c,0x6f,0x72,0x65,0x73,0x20,0x65,0x6f,0x73,0x20,0x71,0x75,0x69,0x20,0x72,0x61,0x74,0x69,0x6f,0x6e,0x65,0x20,0x76,0x6f,0x6c,0x75,0x70,0x74,0x61,0x74,0x65,0x6d,0x20,0x73,0x65,0x71,0x75,0x69,0x20,0x6e,0x65,0x73,0x63,0x69,0x75,0x6e,0x74,0x2e,0x20,0x4e,0x65,0x71,0x75,0x65,0x20,0x70,0x6f,0x72,0x72,0x6f,0x20,0x71,0x75,0x69,0x73,0x71,0x75,0x61,0x6d,0x20,0x65,0x73,0x74,0x2c,0x20,0x71,0x75,0x69,0x20,0x64,0x6f,0x6c,0x6f,0x72,0x65,0x6d,0x20,0x69,0x70,0x73,0x75,0x6d,0x20,0x71,0x75,0x69,0x61,0x20,0x64,0x6f,0x6c,0x6f,0x72,0x20,0x73,0x69,0x74,0x20,0x61,0x6d,0x65,0x74,0x2c,0x20,0x63,0x6f,0x6e,0x73,0x65,0x63,0x74,0x65,0x74,0x75,0x72,0x2c,0x20,0x61,0x64,0x69,0x70,0x69,0x73,0x63,0x69,0x20,0x76,0x65,0x6c,0x69,0x74,0x2c,0x20,0x73,0x65,0x64,0x20,0x71,0x75,0x69,0x61,0x20,0x6e,0x6f,0x6e,0x20,0x6e,0x75,0x6d,0x71,0x75,0x61,0x6d,0x20,0x65,0x69,0x75,0x73,0x20,0x6d,0x6f,0x64,0x69,0x20,0x74,0x65,0x6d,0x70,0x6f,0x72,0x61,0x20,0x69,0x6e,0x63,0x69,0x64,0x75,0x6e,0x74,0x20,0x75,0x74,0x20,0x6c,0x61,0x62,0x6f,0x72,0x65,0x20,0x65,0x74,0x20,0x64,0x6f,0x6c,0x6f,0x72,0x65,0x20,0x6d,0x61,0x67,0x6e,0x61,0x6d,0x20,0x61,0x6c,0x69,0x71,0x75,0x61,0x6d,0x20,0x71,0x75,0x61,0x65,0x72,0x61,0x74,0x20,0x76,0x6f,0x6c,0x75,0x70,0x74,0x61,0x74,0x65,0x6d,0x2e,0x20,0x55,0x74,0x20,0x65,0x6e,0x69,0x6d,0x20,0x61,0x64,0x20,0x6d,0x69,0x6e,0x69,0x6d,0x61,0x20,0x76,0x65,0x6e,0x69,0x61,0x6d,0x2c,0x20,0x71,0x75,0x69,0x73,0x20,0x6e,0x6f,0x73,0x74,0x72,0x75,0x6d,0x20,0x65,0x78,0x65,0x72,0x63,0x69,0x74,0x61,0x74,0x69,0x6f,0x6e,0x65,0x6d,0x20,0x75,0x6c,0x6c,0x61,0x6d,0x20,0x63,0x6f,0x72,0x70,0x6f,0x72,0x69,0x73,0x20,0x73,0x75,0x73,0x63,0x69,0x70,0x69,0x74,0x20,0x6c,0x61,0x62,0x6f,0x72,0x69,0x6f,0x73,0x61,0x6d,0x2c,0x20,0x6e,0x69,0x73,0x69,0x20,0x75,0x74,0x20,0x61,0x6c,0x69,0x71,0x75,0x69,0x64,0x20,0x65,0x78,0x20,0x65,0x61,0x20,0x63,0x6f,0x6d,0x6d,0x6f,0x64,0x69,0x20,0x63,0x6f,0x6e,0x73,0x65,0x71,0x75,0x61,0x74,0x75,0x72,0x3f,0x20,0x51,0x75,0x69,0x73,0x20,0x61,0x75,0x74,0x65,0x6d,0x20,0x76,0x65,0x6c,0x20,0x65,0x75,0x6d,0x20,0x69,0x75,0x72,0x65,0x20,0x72,0x65,0x70,0x72,0x65,0x68,0x65,0x6e,0x64,0x65,0x72,0x69,0x74,0x20,0x71,0x75,0x69,0x20,0x69,0x6e,0x20,0x65,0x61,0x20,0x76,0x6f,0x6c,0x75,0x70,0x74,0x61,0x74,0x65,0x20,0x76,0x65,0x6c,0x69,0x74,0x20,0x65,0x73,0x73,0x65,0x20,0x71,0x75,0x61,0x6d,0x20,0x6e,0x69,0x68,0x69,0x6c,0x20,0x6d,0x6f,0x6c,0x65,0x73,0x74,0x69,0x61,0x65,0x20,0x63,0x6f,0x6e,0x73,0x65,0x71,0x75,0x61,0x74,0x75,0x72,0x2c,0x20,0x76,0x65,0x6c,0x20,0x69,0x6c,0x6c,0x75,0x6d,0x20,0x71,0x75,0x69,0x20,0x64,0x6f,0x6c,0x6f,0x72,0x65,0x6d,0x20,0x65,0x75,0x6d,0x20,0x66,0x75,0x67,0x69,0x61,0x74,0x20,0x71,0x75,0x6f,0x20,0x76,0x6f,0x6c,0x75,0x70,0x74,0x61,0x73,0x20,0x6e,0x75,0x6c,0x6c,0x61,0x20,0x70,0x61,0x72,0x69,0x61,0x74,0x75,0x72,0x3f
    };
    EXPECT_EQ(test_utils::mock_sent_data_vectors[0].size(), sizeof(chunk_upload_want));
    EXPECT_EQ(0, memcmp(test_utils::mock_sent_data_vectors[0].data(), chunk_upload_want, sizeof(chunk_upload_want)));

    unsigned char notif_want[] = {
        0x18,0x04,0x04, // magic
        0x1d,0x00, // payload size

        // XOR key
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

        // victim ID
        0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,
        0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,

        0x14, // task complete type

        0x09,0x00,0x00,0x00, // task num
        0x07,0x00,0x00,0x00, // task type
        0x00,0x00,0x00,0x00 // exit code
    };
    EXPECT_EQ(test_utils::mock_sent_data_vectors[1].size(), sizeof(notif_want));
    EXPECT_EQ(0, memcmp(test_utils::mock_sent_data_vectors[1].data(), notif_want, sizeof(notif_want)));
}
